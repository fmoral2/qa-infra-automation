---
- name: Validate input parameters
  assert:
    that:
      - kubernetes_version is regex('^[a-zA-Z0-9.+_-]+$')
      - k3s_channel is regex('^[a-zA-Z0-9._-]*$')
    fail_msg: "Invalid characters in version or channel parameters"

- name: Create K3s directories
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - /etc/rancher/k3s
    - /var/lib/rancher/k3s/server/logs

- name: Generate K3s server configuration
  template:
    src: server-config.yaml.j2
    dest: /etc/rancher/k3s/config.yaml
    mode: '0644'
  when: k3s_node_type in ['cluster-init', 'server']
  notify: restart k3s

- name: Generate K3s agent configuration
  template:
    src: agent-config.yaml.j2
    dest: /etc/rancher/k3s/config.yaml
    mode: '0644'
  when: k3s_node_type == 'agent'
  notify: restart k3s-agent

- name: Set K3s installation environment variables
  set_fact:
    k3s_install_env:
      INSTALL_K3S_VERSION: "{{ kubernetes_version }}"
      INSTALL_K3S_CHANNEL: "{{ k3s_channel if k3s_channel != '' else omit }}"
      INSTALL_K3S_EXEC: "{{ 'agent' if k3s_node_type == 'agent' else omit }}"
      INSTALL_K3S_SKIP_START: "true"

- name: Download and install K3s
  shell: |
    {% for key, value in k3s_install_env.items() if value is not none %}
    export {{ key }}="{{ value }}"
    {% endfor %}
    curl -sfL https://get.k3s.io | sh -
  args:
    creates: /usr/local/bin/k3s
  register: k3s_install_result
  failed_when: k3s_install_result.rc != 0

- name: Determine K3s service name
  set_fact:
    k3s_service_name: "{{ 'k3s-agent' if k3s_node_type == 'agent' else 'k3s' }}"

- name: Enable and start K3s service
  block:
    - name: Enable K3s service
      systemd:
        name: "{{ k3s_service_name }}"
        enabled: yes
        daemon_reload: yes

    - name: Start K3s service
      systemd:
        name: "{{ k3s_service_name }}"
        state: started
      register: k3s_start_result

    - name: Wait for K3s service to be ready
      wait_for:
        port: "{{ '6443' if k3s_node_type in ['cluster-init', 'server'] else '10250' }}"
        host: "127.0.0.1"
        delay: 10
        timeout: 300
      when: k3s_start_result is succeeded

  rescue:
    - name: Get K3s service status
      shell: systemctl status {{ k3s_service_name }}.service
      register: k3s_status
      become: true
      failed_when: false

    - name: Get K3s service journal logs
      shell: journalctl -xeu {{ k3s_service_name }}.service --no-pager -n 50
      register: k3s_logs
      become: true
      failed_when: false

    - name: Display K3s service status and logs
      debug:
        msg: |
          K3s Service Status ({{ k3s_service_name }}):
          {{ k3s_status.stdout_lines | join('\n') }}
          
          K3s Service Journal Logs:
          {{ k3s_logs.stdout_lines | join('\n') }}

    - name: Check K3s configuration file
      shell: cat /etc/rancher/k3s/config.yaml
      register: k3s_config_content
      become: true
      failed_when: false

    - name: Display K3s configuration
      debug:
        msg: |
          K3s Configuration (/etc/rancher/k3s/config.yaml):
          {{ k3s_config_content.stdout_lines | join('\n') }}

    - name: Fail with detailed error information
      fail:
        msg: |
          K3s service ({{ k3s_service_name }}) failed to start. Check the service status and logs above for details.
          Common issues:
          - Configuration file syntax errors
          - Missing or incorrect certificates  
          - Network connectivity issues
          - Insufficient system resources
          - Container runtime issues
          - Token authentication problems

- name: Update kubeconfig server address (cluster-init only)
  replace:
    path: /etc/rancher/k3s/k3s.yaml
    regexp: '127\.0\.0\.1'
    replace: "{{ fqdn if fqdn != '' else kube_api_host }}"
  when: 
    - k3s_node_type == 'cluster-init'
    - fqdn is defined or kube_api_host is defined

- name: Verify K3s installation
  command: /usr/local/bin/k3s --version
  register: k3s_version_output
  changed_when: false
  failed_when: k3s_version_output.rc != 0

- name: Display K3s version
  debug:
    msg: "K3s installed successfully: {{ k3s_version_output.stdout }}"
